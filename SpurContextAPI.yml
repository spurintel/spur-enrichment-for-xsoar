commonfields:
  id: SpurContextAPI
  version: -1
vcShouldKeepItemLegacyProdMachine: false
name: SpurContextAPI
display: SpurContextAPI
category: Data Enrichment & Threat Intelligence
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAAyCAIAAAAYxYiPAAAFVWlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNS41LjAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIgogICAgeG1sbnM6ZXhpZj0iaHR0cDovL25zLmFkb2JlLmNvbS9leGlmLzEuMC8iCiAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyIKICAgIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIKICAgIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIKICAgIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIgogICAgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIKICAgZXhpZjpQaXhlbFhEaW1lbnNpb249IjEyMCIKICAgZXhpZjpQaXhlbFlEaW1lbnNpb249IjUwIgogICBleGlmOkNvbG9yU3BhY2U9IjEiCiAgIHRpZmY6SW1hZ2VXaWR0aD0iMTIwIgogICB0aWZmOkltYWdlTGVuZ3RoPSI1MCIKICAgdGlmZjpSZXNvbHV0aW9uVW5pdD0iMiIKICAgdGlmZjpYUmVzb2x1dGlvbj0iNzIvMSIKICAgdGlmZjpZUmVzb2x1dGlvbj0iNzIvMSIKICAgcGhvdG9zaG9wOkNvbG9yTW9kZT0iMyIKICAgcGhvdG9zaG9wOklDQ1Byb2Zp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
description: Enrich indicators using the Spur Context API.
configuration:
- display: ""
  displaypassword: API Token
  name: credentials
  type: 9
  required: true
  hiddenusername: true
script:
  script: |
    import ipaddress
    import urllib3
    import urllib.parse
    from typing import Any, Dict
    import json

    # Disable insecure warnings
    urllib3.disable_warnings()


    ''' CONSTANTS '''

    DATE_FORMAT = '%Y-%m-%dT%H:%M:%SZ'  # ISO8601 format with UTC, default in XSOAR

    ''' CLIENT CLASS '''


    class Client(BaseClient):
        """Client class to interact with the service API

        This Client implements API calls, and does not contain any XSOAR logic.
        Should only do requests and return data.
        It inherits from BaseClient defined in CommonServer Python.
        Most calls use _http_request() that handles proxy, SSL verification, etc.
        For this  implementation, no special attributes defined
        """

        def ip(self, ip: str) -> CommandResults:
            """Returns a Spur Context API response as a flattened dictionary for the given input ip.

            :type ip: ``str``
            :param ip: ip address to enrich

            :return: dict
            :rtype: ``str``
            """

            # Validate that the input is a valid IP address
            try:
                ipaddress.ip_address(ip)
            except ValueError:
                raise ValueError(f'Invalid IP address: {ip}')
            encoded_ip = urllib.parse.quote(ip)
            full_url = urljoin(self._base_url, "/v2/context")
            full_url = urljoin(full_url, encoded_ip)
            demisto.debug(f'SpurContextAPI full_url: {full_url}')

            response = self._http_request(
                method='GET',
                full_url=full_url,
                headers=self._headers,
            )

            # Make sure the response is a dictionary
            if isinstance(response, dict):
                response = fix_nested_client(response)
                return CommandResults(
                    outputs_prefix='SpurContextAPI.Context',
                    outputs_key_field='',
                    outputs=response,
                    raw_response=response,
                )
            else:
                raise ValueError(f'Invalid response from API: {response}')


    ''' HELPER FUNCTIONS '''

    def fix_nested_client(data):
        """
        Flatten the data from the API to a format that can be used as outputs
        """
        new_dict = data.copy()
        del new_dict["client"]
        if "client" in data:
            client = data["client"]
            new_dict["client_behaviors"] = client.get("behaviors", [])
            new_dict["client_countries"] = client.get("countries", 0)
            new_dict["client_spread"] = client.get("spread", 0)
            new_dict["client_proxies"] = client.get("proxies", [])
            new_dict["client_count"] = client.get("count", 0)
            new_dict["client_types"] = client.get("types", [])
            if "concentration" in client:
                new_dict["client_concentration"] = data["client"]["concentration"]

        return new_dict


    ''' COMMAND FUNCTIONS '''


    def test_module(client: Client) -> str:
        """Tests API connectivity and authentication'

        Returning 'ok' indicates that the integration works like it is supposed to.
        Connection to the service is successful.
        Raises exceptions if something goes wrong.

        :type client: ``Client``
        :param Client: client to use

        :return: 'ok' if test passed, anything else will fail the test.
        :rtype: ``str``
        """

        message: str = ''
        try:
            full_url = urljoin(client._base_url, 'status')
            demisto.debug(f'SpurContextAPI full_url: {full_url}')
            client._http_request(
                method='GET',
                full_url=full_url,
                headers=client._headers,
                raise_on_status=True,
            )
            message = 'ok'
        except DemistoException as e:
            if 'Forbidden' in str(e) or 'Authorization' in str(e):  # TODO: make sure you capture authentication errors
                message = 'Authorization Error: make sure API Key is correctly set'
            else:
                raise e
        return message


    def enrich_command(client: Client, args: Dict[str, Any]) -> CommandResults:
        ip = args.get('ip', None)
        if not ip:
            raise ValueError('IP not specified')

        return client.ip(ip)

    ''' MAIN FUNCTION '''


    def main() -> None:
        """main function, parses params and runs command functions

        :return:
        :rtype:
        """

        api_key = demisto.params().get('credentials', {}).get('password')
        base_url = "https://api.spur.us/"
        verify_certificate = not demisto.params().get('insecure', False)
        proxy = demisto.params().get('proxy', False)

        demisto.debug(f'Command being called is {demisto.command()}')
        try:

            headers: dict = {
                "TOKEN": api_key
            }

            client = Client(
                base_url=base_url,
                verify=verify_certificate,
                headers=headers,
                proxy=proxy)

            if demisto.command() == 'test-module':
                # This is the call made when pressing the integration Test button.
                result = test_module(client)
                return_results(result)

            elif demisto.command() == 'spur-context-api-enrich':
                return_results(enrich_command(client, demisto.args()))

        # Log exceptions and return errors
        except Exception as e:
            return_error(f'Failed to execute {demisto.command()} command.\nError:\n{str(e)}')


    ''' ENTRY POINT '''


    if __name__ in ('__main__', '__builtin__', 'builtins'):
        main()
  type: python
  commands:
  - name: spur-context-api-enrich
    arguments:
    - name: ip
      required: true
      description: IP address to enrich.
    outputs:
    - contextPath: SpurContextAPI.Context.ip
      type: string
    - contextPath: SpurContextAPI.Context.as
    - contextPath: SpurContextAPI.Context.organization
      type: string
    - contextPath: SpurContextAPI.Context.infrastructure
      type: string
    - contextPath: SpurContextAPI.Context.location
    - contextPath: SpurContextAPI.Context.services
    - contextPath: SpurContextAPI.Context.tunnels
    - contextPath: SpurContextAPI.Context.risks
    - contextPath: SpurContextAPI.Context.client_concentration
    - contextPath: SpurContextAPI.Context.client_countries
    - contextPath: SpurContextAPI.Context.client_spread
    - contextPath: SpurContextAPI.Context.client_proxies
    - contextPath: SpurContextAPI.Context.client_count
    - contextPath: SpurContextAPI.Context.client_behaviors
    - contextPath: SpurContextAPI.Context.client_types
    description: Enrich an IP address with the Spur Context API
  dockerimage: demisto/python3:3.10.13.87159
  runonce: false
  subtype: python3
sourcemoduleid: SpurContextAPI
